<?php\n// import_db.php\n// 在 SSH 中运行: php /path/to/your/project/backend/import_db.php\n\nrequire_once __DIR__ . '/db.php';\n\ntry {\n    $pdo = getDBConnection();\n    echo \"Successfully connected to the database.\\n\";\n\n    $sql = \"\n    -- 删除已存在的表，用于重新初始化\n    DROP TABLE IF EXISTS `settlement_results`, `user_game_submissions`, `batch_player_status`, `game_batches`, `pre_generated_games`, `users`;\n\n    -- 用户表\n    CREATE TABLE `users` (\n      `id` INT AUTO_INCREMENT PRIMARY KEY,\n      `user_id_4d` VARCHAR(4) NOT NULL UNIQUE,\n      `phone` VARCHAR(20) NOT NULL UNIQUE,\n      `password_hash` VARCHAR(255) NOT NULL,\n      `points` BIGINT NOT NULL DEFAULT 1000,\n      `auth_token` VARCHAR(64) NULL UNIQUE,\n      `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n    -- 预生成牌局表\n    CREATE TABLE `pre_generated_games` (\n        `id` INT AUTO_INCREMENT PRIMARY KEY,\n        `table_id` INT NOT NULL,\n        `game_index_in_table` INT NOT NULL,\n        `dealt_cards_json` JSON NOT NULL,\n        INDEX (`table_id`, `game_index_in_table`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n    -- 场次管理表 (已简化，只作标识)\n    CREATE TABLE `game_batches` (\n        `id` INT AUTO_INCREMENT PRIMARY KEY,\n        `table_id` INT NOT NULL,\n        `batch_number` INT NOT NULL,\n        `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        UNIQUE KEY (`table_id`, `batch_number`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n    -- 玩家场次状态表\n    CREATE TABLE `batch_player_status` (\n        `id` INT AUTO_INCREMENT PRIMARY KEY,\n        `user_id` INT NOT NULL,\n        `batch_id` INT NOT NULL,\n        `status` ENUM('in_progress', 'completed', 'settled', 'abandoned') NOT NULL DEFAULT 'in_progress',\n        `games_played_count` INT NOT NULL DEFAULT 0,\n        `assignment_order_json` JSON NOT NULL, -- 存储乱序后的牌局索引\n        `completed_at` TIMESTAMP NULL,\n        `settlement_group_id` INT NULL,\n        FOREIGN KEY (`user_id`) REFERENCES `users`(`id`),\n        FOREIGN KEY (`batch_id`) REFERENCES `game_batches`(`id`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\n    -- 玩家单局提交记录表\n    CREATE TABLE `user_game_submissions` (\n        `id` INT AUTO_INCREMENT PRIMARY KEY,\n        `user_id` INT NOT NULL,\n        `pre_gen_game_id` INT NOT NULL,\n        `submitted_cards_json` JSON NOT NULL,\n        `is_ai_generated` BOOLEAN NOT NULL DEFAULT FALSE,\n        `submitted_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        FOREIGN KEY (`user_id`) REFERENCES `users`(`id`),\n        FOREIGN KEY (`pre_gen_game_id`) REFERENCES `pre_generated_games`(`id`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n    \n    -- 结算结果详情表\n    CREATE TABLE `settlement_results` (\n        `id` INT AUTO_INCREMENT PRIMARY KEY,\n        `settlement_group_id` INT NOT NULL,\n        `user_id` INT NOT NULL,\n        `pre_gen_game_id` INT NOT NULL,\n        `score` INT NOT NULL,\n        `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        INDEX (`settlement_group_id`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n    \";\n\n    $pdo->exec($sql);\n    echo \"All tables created successfully.\\n\";\n\n} catch (PDOException \$e) {\n    die(\"Database error: \" . \$e->getMessage() . \"\\n\");\n}