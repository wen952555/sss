<?php\n// api.php\nheader(\"Content-Type: application/json\");\nheader(\"Access-Control-Allow-Origin: *\"); // 在Cloudflare Worker代理模式下，这个可以宽松设置\nheader(\"Access-Control-Allow-Methods: GET, POST, OPTIONS\");\nheader(\"Access-Control-Allow-Headers: Content-Type, Authorization\");\n\n// 处理 OPTIONS 预检请求\nif ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {\n    exit(0);\n}\n\nrequire_once __DIR__ . '/db.php';\nrequire_once __DIR__ . '/handlers/user_handler.php';\nrequire_once __DIR__ . '/handlers/game_handler.php';\n\n$action = $_GET['action'] ?? '';\n$data = json_decode(file_get_contents('php://input'), true);\n\n$pdo = getDBConnection();\n\n// 无需认证的路由\nswitch ($action) {\n    case 'register':\n        handleRegister($pdo, $data);\n        exit;\n    case 'login':\n        handleLogin($pdo, $data);\n        exit;\n}\n\n// ---- 需要认证的路由 ----\n$headers = getallheaders();\n$authHeader = $headers['Authorization'] ?? '';\n$token = str_replace('Bearer ', '', $authHeader);\n\n$user = getUserByToken($pdo, $token);\nif (!$user) {\n    http_response_code(401);\n    echo json_encode(['success' => false, 'message' => 'Unauthorized']);\n    exit;\n}\n\n// 已认证的路由\nswitch ($action) {\n    case 'get-user':\n        echo json_encode(['success' => true, 'user' => ['id' => $user['id'], 'user_id_4d' => $user['user_id_4d'], 'phone' => $user['phone'], 'points' => $user['points']]]);\n        break;\n    case 'tables-status':\n        handleGetTablesStatus($pdo, $user['id']);\n        break;\n    // ... 其他游戏相关的路由\n    default:\n        http_response_code(404);\n        echo json_encode(['success' => false, 'message' => 'Action not found']);\n        break;\n}