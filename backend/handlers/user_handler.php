<?php\n// handlers/user_handler.php\n\nfunction handleRegister($pdo, $data) {\n    $phone = $data['phone'] ?? '';\n    $password = $data['password'] ?? '';\n\n    if (empty($phone) || empty($password)) {\n        http_response_code(400);\n        echo json_encode(['success' => false, 'message' => 'Phone and password are required.']);\n        return;\n    }\n\n    // 检查手机号是否已存在\n    $stmt = $pdo->prepare(\"SELECT id FROM users WHERE phone = ?\");\n    $stmt->execute([$phone]);\n    if ($stmt->fetch()) {\n        http_response_code(409);\n        echo json_encode(['success' => false, 'message' => 'Phone number already registered.']);\n        return;\n    }\n\n    // 生成唯一的4位数ID\n    do {\n        $userId4d = str_pad(mt_rand(1000, 9999), 4, '0', STR_PAD_LEFT);\n        $stmt = $pdo->prepare(\"SELECT id FROM users WHERE user_id_4d = ?\");\n        $stmt->execute([$userId4d]);\n    } while ($stmt->fetch());\n\n    $passwordHash = password_hash($password, PASSWORD_DEFAULT);\n\n    $stmt = $pdo->prepare(\"INSERT INTO users (user_id_4d, phone, password_hash) VALUES (?, ?, ?)\");\n    if ($stmt->execute([$userId4d, $phone, $passwordHash])) {\n        echo json_encode(['success' => true, 'message' => 'Registration successful.']);\n    } else {\n        http_response_code(500);\n        echo json_encode(['success' => false, 'message' => 'Failed to register user.']);\n    }\n}\n\nfunction handleLogin($pdo, $data) {\n    $phone = $data['phone'] ?? '';\n    $password = $data['password'] ?? '';\n\n    $stmt = $pdo->prepare(\"SELECT id, password_hash FROM users WHERE phone = ?\");\n    $stmt->execute([$phone]);\n    $user = $stmt->fetch();\n\n    if ($user && password_verify($password, $user['password_hash'])) {\n        $token = bin2hex(random_bytes(32));\n        $updateStmt = $pdo->prepare(\"UPDATE users SET auth_token = ? WHERE id = ?\");\n        $updateStmt->execute([$token, $user['id']]);\n        echo json_encode(['success' => true, 'token' => $token]);\n    } else {\n        http_response_code(401);\n        echo json_encode(['success' => false, 'message' => 'Invalid phone or password.']);\n    }\n}\n\nfunction getUserByToken($pdo, $token) {\n    if (empty($token)) {\n        return null;\n    }\n    $stmt = $pdo->prepare(\"SELECT id, user_id_4d, phone, points FROM users WHERE auth_token = ?\");\n    $stmt->execute([$token]);\n    return $stmt->fetch();\n}